<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html" />
<link rel="import" href="../bower_components/paper-button/paper-button.html" />
<link rel="import" href="fsd-building-detail-view.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="fsd-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="fsd-list">
  <template>
    <style include="shared-styles">
      :host {
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="/:buildingId"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <div class="filter-card clearfix col12">
      <input value="{{buildingFilters.buildingName::input}}" class="pad1 col10 margin1" placeholder="filter">
    </div>

    <div id="result-container" class="col12 clearflix">
        <template id="resultList" is="dom-repeat" items="{{ buildingList }}" initial-count="10">
            <div class="card">
                <fsd-building-detail-view building-item="[[ item ]]"></fsd-building-detail-view>
            </div>
        </template> <!-- dom-repeat -->
    </div>

    <paper-dialog id="building-detail-modal" modal on-iron-overlay-opened="patchOverlay">
            <div class="buttons">
                <paper-icon-button dialog-confirm icon="fsd-icons:close"></paper-icon-button>
            </div>
        <fsd-building-detail-view building-item="[[ modalBuilding ]]" expanded></fsd-building-detail-view>
    </paper-dialog>

      </template>


 <script>
    Polymer({
      is: 'fsd-list',
      listeners: {
      },
      properties: {
        // Selected buildings coming from fsd-app.
        buildingFilters: {
          type: Array,
          notify: true
        },

        buildingList: {
          type: Array,
          notify: true,
          readOnly: true,
          value: function () {
            return [];
          }
        },
        modalBuilding: {
          type: Object,
          notify: true
        },
        // Prcessed bldg data coming from fsd-app.
        processedBuildings: {
          type: Object,
          notify: true
        },
        routeData: {
          type: Object,
          notify: true
        },
        activeBuildingId: {
          type: String,
          observer: '_activeBuildingIdChanged'
        },
      },
      observers: [
        '_buildingDataUpdated(processedBuildings.*, buildingFilters.*)',
        '_routeDataChanged(routeData.*)',
        '_modalBuildingChanged(modalBuilding.*)'
      ],
      filterBuilding(building) {
        console.log(building);
        console.log(this.buildingFilters);
        // Assume true, filter out.
        const isResult = true;

        if (this.buildingFilters.buildingType && building.properties.asset_type !== this.buildingFilters.buildingType)
          return false;

        return isResult;
      },
      _routeDataChanged(routeDataDelta) {
        if (routeDataDelta.value.buildingId) {
          this.debounce('showModal', () => {
            this.set('activeBuildingId', this.routeData.buildingId);
          }, 1000);
        }
      },

      patchOverlay: function (e) {
        if (e.target.withBackdrop) {
          e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
        }
      },

      _modalBuildingChanged: function(modalBuildingDelta) {
        console.log(modalBuildingDelta);
        if (modalBuildingDelta.value)
          Polymer.dom(this.root).querySelector('#building-detail-modal').open();
      },
      _activeBuildingIdChanged: function(newVal, oldVal) {
        console.log(newVal);
        console.log(oldVal);
        console.log(Polymer.dom(this.root).querySelector('#building-detail-modal'));
        console.log(this.processedBuildings);
          if (this.processedBuildings) {
            const modalBuildingIndex = _.findIndex(this.processedBuildings.features, function(buildingFeature) {
                return buildingFeature.properties.building_number == newVal;
            });
            if (modalBuildingIndex !== -1)
              this.set('modalBuilding', this.processedBuildings.features[modalBuildingIndex]);
            else
              this.set('modalBuilding', null);
          }
      },
      _buildingDataUpdated: function(processedBuildingsDelta, buildingFiltersDelta) {
        this.debounce('processBuildings', () => {

          console.log(processedBuildingsDelta);
          console.log(buildingFiltersDelta);
          console.log(this.buildingFilters);
          var rawBuildings = this.processedBuildings.features;
            rawBuildings = _.filter(rawBuildings, (building) => {
              if (this.buildingFilters.buildingType && building.properties.asset_type !==
                      this.buildingFilters.buildingType) {
                  return false;
              }
//console.log(building.properties.building_name.match(new RegExp(this.buildingFilters.buildingName, 'i')));

              if (this.buildingFilters.buildingName &&
                      building.properties.building_name.match(new RegExp(this.buildingFilters.buildingName, 'i')) === null) {
                  return false;
              }

              return true;
            });
          //}

          this._setBuildingList(rawBuildings);

        }, 1000);
      },
    });
  </script>
</dom-module>
